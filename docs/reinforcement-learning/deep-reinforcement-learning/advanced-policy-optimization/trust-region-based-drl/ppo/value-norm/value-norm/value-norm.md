# Value Norm

- [è¿”å›ä¸Šå±‚ç›®å½•](../value-norm.md)



# å¸¸è§„Value-Normçš„ä¼˜ç¼ºç‚¹ä»¥åŠä¸PopArtçš„åŒºåˆ«

## å¸¸è§„Value-Normçš„ä¼˜ç¼ºç‚¹

å¸¸è§„Value-Normå¾ˆå¤šå®ç°æ˜¯è¿™æ ·çš„æµç¨‹ï¼š

```python
# 1. ç½‘ç»œè¾“å‡ºçœŸå®å€¼
v_pred = critic(obs)  # shape: (B,)

# 2. å¯¹ target åšæ ‡å‡†åŒ–ï¼ˆæ¯”å¦‚ç”¨æ»‘åŠ¨ mean/stdï¼‰
target_norm = (target - mean) / std

# 3. ä¹Ÿå¯¹ç½‘ç»œè¾“å‡ºåšæ ‡å‡†åŒ–ï¼ˆä¸ºäº†è®¡ç®— lossï¼‰
v_pred_norm = (v_pred - mean) / std

# 4. ç”¨å½’ä¸€åŒ–çš„ä¸¤è€…è®¡ç®— loss
loss = MSE(v_pred_norm, target_norm)
```

âœ… è¿™ç§åšæ³•çš„ä¼˜ç‚¹ï¼š

- **ç½‘ç»œä»ç„¶è¾“å‡ºçœŸå®å€¼**ï¼ˆv_pred æ˜¯æœªå½’ä¸€åŒ–çš„ï¼‰
- åªæ˜¯è®­ç»ƒæ—¶è®¡ç®— loss çš„æ—¶å€™ï¼Œ**åšäº†ä¸€ä¸ªå¯æ§èŒƒå›´çš„å½’ä¸€åŒ–**ï¼Œé¿å… loss å¿½å¤§å¿½å°
- ç®€å•ç›´æ¥ã€ä¸ç ´åå€¼å‡½æ•°ç»“æ„

âš ï¸ æ½œåœ¨é—®é¢˜æ˜¯ï¼š

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè™½ç„¶æˆ‘ä»¬â€œæ²¡åŠ¨ç½‘ç»œç»“æ„â€ï¼Œä½†ï¼š

- **æ¢¯åº¦æ˜¯åŸºäºå½’ä¸€åŒ–åçš„å€¼è®¡ç®—çš„**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š
  - åå‘ä¼ æ’­æ—¶ï¼Œ`v_pred_norm = (v_pred - mean) / std`
  - æ‰€ä»¥ `âˆ‚loss/âˆ‚v_pred = (1 / std) * âˆ‚loss/âˆ‚v_pred_norm`

â¡ï¸ è¿™å°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼š

> ğŸ’¡ **è®­ç»ƒæ—¶çš„æ¢¯åº¦ scale æ˜¯è¢« std æ§åˆ¶çš„ï¼Œæ˜¯â€œéšå¼ä¾èµ–â€äº mean/std çš„ï¼**

è¿™åœ¨ç›®æ ‡å˜åŒ–å‰§çƒˆã€è·¨ä»»åŠ¡æˆ–å¤šå°ºåº¦å€¼åŸŸæ—¶ï¼Œä»å¯èƒ½é€ æˆè®­ç»ƒä¸ç¨³å®šã€‚

**PopArt çš„æ”¹è¿›ç‚¹æ˜¯ï¼š**

PopArt ä¸ä»…å½’ä¸€åŒ– targetï¼Œè¿˜é€šè¿‡è°ƒæ•´æœ€åä¸€å±‚çš„ W å’Œ bï¼Œè®©ç½‘ç»œç›´æ¥è¾“å‡ºçš„æ˜¯æ ‡å‡†åŒ–å€¼ï¼Œå†é€šè¿‡ä¸€å±‚â€œè‡ªåŠ¨åå½’ä¸€åŒ–â€è¿˜åŸå‡ºçœŸå®å€¼ã€‚

æ¢å¥è¯è¯´ï¼š

- **PopArt æ”¹å˜äº†ç½‘ç»œå‚æ•°çš„è¡¨ç¤ºæ–¹å¼**ï¼ˆç­‰ä»·åœ°å­¦ä¹ åœ¨å¦ä¸€ä¸ªç©ºé—´ï¼‰
- **loss æ˜¯åŸºäºæ ‡å‡†åŒ–çš„ç›®æ ‡ï¼Œè¾“å‡ºå´æ˜¯éæ ‡å‡†åŒ–çš„å€¼**

æ‰€ä»¥ï¼š

| æ–¹æ³•            | è¾“å‡ºæ˜¯å¦æ˜¯åŸå§‹ valueï¼Ÿ | loss ä½¿ç”¨å½’ä¸€åŒ–ï¼Ÿ | æ˜¯å¦ä¿®æ­£ W/bï¼Ÿ | æ¢¯åº¦ scale æ˜¯å¦ç¨³å®šï¼Ÿ |
| --------------- | ---------------------- | ----------------- | -------------- | --------------------- |
| å¸¸è§„ value norm | âœ… æ˜¯                   | âœ… æ˜¯              | âŒ å¦           | âš ï¸ ä¸ä¸€å®šï¼Œå— std å½±å“ |
| PopArt          | âœ… æ˜¯                   | âœ… æ˜¯              | âœ… æ˜¯           | âœ… æ˜¯ï¼Œä¸»åŠ¨æ§åˆ¶        |

æ€»ç»“ä¸€ä¸‹ï¼š

ä½ è¯´å¾—æ²¡é”™ï¼š

> âœ… â€œå¸¸è§„ value norm ä¸ä¼šå½±å“ value ç½‘ç»œè¾“å‡ºçš„å€¼ï¼Œå®ƒä»ç„¶è¾“å‡ºçœŸå®å€¼ã€‚â€

ä½†ï¼š

> âš ï¸ å®ƒä»ç„¶ä¼šè®©æ¢¯åº¦ scale ä¾èµ–äº stdï¼Œä¼šå½±å“è®­ç»ƒçš„ç¨³å®šæ€§å’Œç­–ç•¥åŒæ­¥æ€§ã€‚

è€Œ PopArt åšäº†æ›´è¿›ä¸€æ­¥çš„å¤„ç†ï¼Œè®©è¾“å‡ºå’Œ loss åœ¨ä¸¤ä¸ªç©ºé—´ä¸­éƒ½ä¸€è‡´ï¼Œ**æ˜¾å¼åœ°è§£è€¦äº†æ¢¯åº¦ scale ä¸ std çš„å…³ç³»**ï¼Œæ‰€ä»¥å®ƒçš„è®­ç»ƒæ›´å¥å£®ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šä»»åŠ¡ã€å¤šå°ºåº¦ reward çš„ç¯å¢ƒä¸­ã€‚

## ä¸PopArtçš„åŒºåˆ«

PopArt ä¸ç®€å•çš„ mean/std å½’ä¸€åŒ– **æœ¬è´¨ä¸Šæ˜¯ä¸¤ç§ç­–ç•¥**ï¼Œå®ƒä»¬çš„ **èŒè´£è¾¹ç•Œä¸åŒ**ï¼š

| ç‰¹æ€§                    | æ™®é€š Mean/Std å½’ä¸€åŒ–  | PopArt                                                  |
| ----------------------- | --------------------- | ------------------------------------------------------- |
| å½’ä¸€åŒ–ç›®æ ‡              | ä»…ä½œç”¨äº value target | åŒæ—¶ä½œç”¨äº target å’Œ value ç½‘ç»œè¾“å‡ºï¼ˆé€šè¿‡å˜æ¢æœ€åä¸€å±‚ï¼‰ |
| æ˜¯å¦éœ€æ„ŸçŸ¥ç½‘ç»œç»“æ„      | âŒ ä¸éœ€è¦              | âœ… å¿…é¡»çŸ¥é“æœ€åä¸€å±‚                                      |
| å¯¹ value ç½‘ç»œç»“æ„æœ‰ä¾èµ– | âŒ å®Œå…¨ç‹¬ç«‹            | âœ… éœ€è¦ä¿®æ”¹ç½‘ç»œæˆ–æ³¨å†Œæœ€åä¸€å±‚                            |
| æ˜¯å¦ä¿®æ”¹æƒé‡            | âŒ ä¸ä¿®æ”¹              | âœ… æ›´æ–° mean/std çš„åŒæ—¶ä¿®æ”¹æƒé‡å’Œåç½®                    |
| å®ç°å¤æ‚åº¦              | ç®€å•                  | é«˜ï¼ˆæ¶‰åŠæ•°å€¼ç¨³å®šæ€§ä¸æ¢¯åº¦åŒæ­¥ï¼‰                          |

æ‰€ä»¥æŠŠè¿™ä¸¤è€…ã€Œå¼ºè¡Œå°è£…ã€è¿›åŒä¸€ä¸ªç±»è™½ç„¶èƒ½å®ç°ï¼Œä½†ä¼šå¯¼è‡´ï¼š

- æ¨¡å—å†…éƒ¨é€»è¾‘éå¸¸å¤æ‚ï¼ˆéœ€è¦åˆ¤æ–­æ˜¯å¦æœ‰ `linear`ï¼Œè¿˜å¾—å¤„ç†å„ç§ `if use_popart`ï¼‰
- å¤–éƒ¨ä½¿ç”¨æ—¶ API ä¸ä¸€è‡´ï¼Œå®¹æ˜“å‡º bug
- ç”¨æˆ·ç†è§£æˆæœ¬ä¸Šå‡ï¼šä¸æ¸…æ¥šä½•æ—¶å¯ç”¨ popart æ¨¡å¼ï¼Œä½•æ—¶åªå½’ä¸€åŒ– target

# ä»£ç å®ç°

ä¸‹é¢æ˜¯**ValueNormalizer**çš„çº¯ä»£ç å®ç°ï¼Œæ”¯æŒæ ‡å‡†çš„ mean/std å½’ä¸€åŒ–ä¸åå½’ä¸€åŒ–ï¼ˆç”¨äº baseline çš„å€¼æ ‡å‡†åŒ–ï¼‰

```python
import torch
import torch.nn as nn

class ValueNormalizer(nn.Module):
    def __init__(self, epsilon=1e-5, device="cpu"):
        super().__init__()
        self.mean = torch.zeros(1, device=device)
        self.var = torch.ones(1, device=device)
        self.epsilon = epsilon

    def update(self, targets):
        self.mean.data = targets.mean().detach()
        self.var.data = targets.var(unbiased=False).detach()

    def normalize(self, targets):
        return (targets - self.mean) / (self.var + self.epsilon).sqrt()

    def denormalize(self, values):
        return values * (self.var + self.epsilon).sqrt() + self.mean
```

