# åŸºäºRayçš„å¼ºåŒ–å­¦ä¹ å¹¶è¡Œè®­ç»ƒæ¡†æ¶

* [è¿”å›ä¸Šå±‚ç›®å½•](../ray.md)
* [Rayå¹¶è¡Œè®­ç»ƒæ–¹å¼ä»‹ç»](#Rayå¹¶è¡Œè®­ç»ƒæ–¹å¼ä»‹ç»)



# Rayå¹¶è¡Œè®­ç»ƒæ–¹å¼ä»‹ç»

Rayæ˜¯ä¸€ä¸ªç”¨äºå¹¶è¡Œè®¡ç®—çš„æ¡†æ¶ï¼Œä¸»è¦ç”¨äºåŠ é€Ÿæœºå™¨å­¦ä¹ å’Œå¼ºåŒ–å­¦ä¹ ä»»åŠ¡ã€‚å®ƒå¯ä»¥åœ¨å¤šä¸ªCPUæ ¸å¿ƒæˆ–è€…å¤šä¸ªæœºå™¨ä¸Šå¹¶è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œæå¤§åœ°æå‡è®¡ç®—æ•ˆç‡ã€‚Rayæä¾›äº†ä¸¤ç§ä¸»è¦æ–¹å¼æ¥åŠ é€Ÿå¼ºåŒ–å­¦ä¹ ï¼š

1. **è‡ªå·±åŸºäºRayå®ç°å¤šç¯å¢ƒå¹¶è¡Œï¼ˆè‡ªå®šä¹‰Ray Actorï¼‰**
2. **ç›´æ¥ä½¿ç”¨Ray RLlibï¼ˆRayå®˜æ–¹å¼ºåŒ–å­¦ä¹ åº“ï¼‰**

## è‡ªå·±åŸºäºRayå®ç°å¤šç¯å¢ƒå¹¶è¡Œ

**æ ¸å¿ƒæ€è·¯**ï¼šä½¿ç”¨Rayçš„Actoræ¨¡å‹ï¼Œæ‰‹åŠ¨å¹¶è¡Œå¤šä¸ªç¯å¢ƒå®ä¾‹ï¼Œé‡‡æ ·æ•°æ®ï¼Œå¹¶å–‚ç»™ä½ çš„PPOç®—æ³•ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š

- ä½ å·²ç»æœ‰è‡ªå·±çš„PPOä»£ç ï¼ˆä¸æ˜¯ç”¨Ray RLlibçš„PPOï¼‰ã€‚
- ä½ å¸Œæœ›æœ€å¤§ç¨‹åº¦åœ°æ§åˆ¶ä»£ç é€»è¾‘ï¼Œæ¯”å¦‚å¦‚ä½•æ”¶é›†æ•°æ®ã€å¦‚ä½•å¤„ç†ç¯å¢ƒäº¤äº’ç­‰ã€‚

**å®ç°æ–¹å¼**ï¼š

1. ç”¨Rayçš„`@ray.remote`è£…é¥°å™¨ï¼ŒæŠŠä½ çš„C++ç¯å¢ƒå°è£…æˆRayçš„Actorã€‚
2. åœ¨Pythoné‡Œå¯åŠ¨å¤šä¸ªç¯å¢ƒå®ä¾‹ï¼Œè®©å®ƒä»¬å¹¶è¡Œè¿è¡Œã€‚
3. æ”¶é›†æ‰€æœ‰ç¯å¢ƒçš„ç»éªŒæ•°æ®ï¼Œå¹¶ä¼ ç»™ä½ çš„PPOè®­ç»ƒä»£ç ã€‚

```python
import ray
import zmq
import numpy as np

ray.init()  # åˆå§‹åŒ–Ray

# å®šä¹‰ä¸€ä¸ªRayçš„Actorï¼Œå°è£…ä½ çš„C++ç¯å¢ƒ
@ray.remote
class EnvActor:
    def __init__(self, env_id):
        self.env_id = env_id
        np.random.seed(env_id)  # ç¡®ä¿ä¸åŒç¯å¢ƒè¡Œä¸ºä¸åŒ

    def step(self, action):
        """æ¨¡æ‹Ÿäº¤äº’ï¼Œè¿”å› (obs, reward, done)"""
        time.sleep(np.random.uniform(0.01, 0.05))  # æ¨¡æ‹Ÿä¸åŒç¯å¢ƒçš„è®¡ç®—æ—¶é—´
        obs = np.random.rand(3)  # ä¼ªé€ è§‚æµ‹å€¼
        reward = np.random.rand()  # ä¼ªé€ å¥–åŠ±
        done = np.random.rand() < 0.05  # ä¼ªé€ ç»ˆæ­¢æ ‡å¿—
        return obs, reward, done

    def reset(self):
        """å¤ä½ç¯å¢ƒ"""
        return np.random.rand(3)

# å¯åŠ¨å¤šä¸ªç¯å¢ƒå®ä¾‹
num_envs = 4
envs = [EnvActor.remote(5555 + i) for i in range(num_envs)]

# é‡‡æ ·æ•°æ®
actions = [np.random.randint(0, 3) for _ in range(num_envs)]
results = ray.get([env.step.remote(action) for env, action in zip(envs, actions)])

print(results)  # è·å–å¤šä¸ªç¯å¢ƒçš„å¹¶è¡Œç»“æœ
```

è¿™æ ·ï¼Œä½ çš„ç¯å¢ƒå¯ä»¥å¹¶è¡Œè¿è¡Œå¤šä¸ªå®ä¾‹ï¼ŒåŠ é€Ÿæ•°æ®é‡‡æ ·ã€‚

## ç›´æ¥ä½¿ç”¨Ray-RLlib

å‚è€ƒ[ray.rllibå…¥é—¨å®è·µ-1ï¼š å¿«é€Ÿè·‘é€š](https://blog.csdn.net/Strive_For_Future/article/details/145340589)

**æ ¸å¿ƒæ€è·¯**ï¼šRay RLlibæ˜¯Rayæä¾›çš„å¼ºåŒ–å­¦ä¹ åº“ï¼Œå†…éƒ¨å·²ç»å®ç°äº†PPOç®—æ³•ï¼Œå¹¶æ”¯æŒè‡ªåŠ¨å¹¶è¡ŒåŒ–ç¯å¢ƒç®¡ç†ã€‚ä½ åªéœ€è¦å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰çš„ç¯å¢ƒé€‚é…å™¨ï¼Œè®©RLlibè°ƒç”¨ä½ çš„C++ç¯å¢ƒå³å¯ã€‚

**é€‚ç”¨åœºæ™¯**ï¼š

- ä½ ä¸æƒ³è‡ªå·±å†™PPOï¼Œè€Œæ˜¯å¸Œæœ›ç”¨RLlibè‡ªå¸¦çš„PPOç®—æ³•ã€‚
- ä½ æ„¿æ„é€‚é…ä½ çš„C++ç¯å¢ƒï¼Œè®©å®ƒç¬¦åˆRLlibçš„ç¯å¢ƒæ¥å£ã€‚

**å®ç°æ–¹å¼**ï¼š

1. **è‡ªå®šä¹‰RLlibç¯å¢ƒ**ï¼Œè®©å®ƒé€šè¿‡ZMQä¸C++ç¯å¢ƒäº¤äº’ã€‚
2. **ç”¨RLlibè®­ç»ƒPPO**ï¼Œå®ƒä¼šè‡ªåŠ¨å¹¶è¡Œå¤šä¸ªç¯å¢ƒå®ä¾‹ã€‚

```python
from ray.rllib.env import ExternalEnv
import numpy as np

class CustomEnv(ExternalEnv):
    def __init__(self, env_id):
        super().__init__()
        self.env_id = env_id
        np.random.seed(env_id)  # ç¡®ä¿ä¸åŒç¯å¢ƒè¡Œä¸ºä¸åŒ

    def run(self):
        while True:
            """æ¨¡æ‹Ÿäº¤äº’ï¼Œè¿”å› (obs, reward, done)"""
            time.sleep(np.random.uniform(0.01, 0.05))  # æ¨¡æ‹Ÿä¸åŒç¯å¢ƒçš„è®¡ç®—æ—¶é—´
            obs = np.random.rand(3)  # ä¼ªé€ è§‚æµ‹å€¼
            reward = np.random.rand()  # ä¼ªé€ å¥–åŠ±
            done = np.random.rand() < 0.05  # ä¼ªé€ ç»ˆæ­¢æ ‡å¿—
            return obs, reward, done

# ç”¨RLlibçš„PPOè¿›è¡Œè®­ç»ƒ
import ray.rllib.algorithms.ppo as ppo
from ray.tune.registry import register_env

def env_creator(env_config):
    return CustomEnv(env_config["zmq_port"])

register_env("CustomEnv-v0", env_creator)

trainer = ppo.PPOTrainer(env="CustomEnv-v0", config={"num_workers": 4})
for _ in range(10):
    result = trainer.train()
    print(result)
```

è¿™æ ·ï¼Œä½ çš„C++ç¯å¢ƒå¯ä»¥è¢«RLlibç®¡ç†ï¼Œå¹¶è‡ªåŠ¨è¿›è¡Œå¤šçº¿ç¨‹è®­ç»ƒã€‚

**ä¸¤ç§æ–¹å¼çš„åŒºåˆ«**

| æ–¹å¼                          | é€‚ç”¨åœºæ™¯                        | ä¼˜åŠ¿                         | ç¼ºç‚¹                      |
| ----------------------------- | ------------------------------- | ---------------------------- | ------------------------- |
| **è‡ªå·±åŸºäºRayå®ç°å¤šç¯å¢ƒå¹¶è¡Œ** | ä½ è‡ªå·±å®ç°PPOï¼Œæƒ³è¦åŠ é€Ÿç¯å¢ƒé‡‡æ · | çµæ´»æ€§é«˜ï¼Œä¸å—RLlibçº¦æŸ      | éœ€è¦è‡ªå·±å®ç°PPOå¹¶ç®¡ç†æ•°æ® |
| **ç›´æ¥ä½¿ç”¨Ray RLlib**         | ä½ å¸Œæœ›ç”¨RLlibçš„PPOç®—æ³•          | çœæ—¶çœåŠ›ï¼Œè‡ªåŠ¨ç®¡ç†å¤šçº¿ç¨‹è®­ç»ƒ | éœ€è¦é€‚é…RLlibçš„ç¯å¢ƒæ¥å£   |

**å»ºè®®**ï¼š

- å¦‚æœä½ å¸Œæœ›å®Œå…¨æŒæ§PPOç®—æ³•ï¼Œå»ºè®® **è‡ªå·±åŸºäºRayå®ç°å¤šç¯å¢ƒå¹¶è¡Œ**ï¼ˆç¬¬ä¸€ç§æ–¹å¼ï¼‰ã€‚
- å¦‚æœä½ æ„¿æ„ç”¨RLlibè‡ªå¸¦çš„PPOï¼Œå¹¶å¸Œæœ›å¿«é€Ÿä¸Šæ‰‹ï¼Œå»ºè®® **ç›´æ¥ä½¿ç”¨Ray RLlib**ï¼ˆç¬¬äºŒç§æ–¹å¼ï¼‰ã€‚

# çŸ¥è¯†ç‚¹

## Rayæä¾›çš„dashboard

- å¯åŠ¨ Ray æ—¶åŠ ï¼š

```
ray.init(include_dashboard=True)
```

- æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://127.0.0.1:8265`
- å¯ä»¥çœ‹åˆ°æ¯ä¸ª worker çš„ CPU / å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠå¯¹è±¡å­˜å‚¨å ç”¨

è¿™ä¸ªç«¯å£å·ä¸æ˜¯éšä¾¿é€‰çš„ï¼Œä¹Ÿä¸æ˜¯ä½ è‡ªå·±è®¾ç½®çš„ï¼Œè€Œæ˜¯ **Ray å†…éƒ¨é»˜è®¤åˆ†é…çš„ dashboard ç«¯å£**ã€‚

å…·ä½“è¯´æ˜ï¼š

1. **é»˜è®¤ç«¯å£**

   - Ray dashboard é»˜è®¤ç›‘å¬ **8265**ï¼ˆä» Ray 2.x å¼€å§‹å°±æ˜¯è¿™ä¸ªé»˜è®¤å€¼ï¼‰ã€‚
   - å¦‚æœ 8265 è¢«å ç”¨ï¼ŒRay ä¼šè‡ªåŠ¨å°è¯• **ä¸‹ä¸€ä¸ªç©ºé—²ç«¯å£**ï¼ˆ8266ã€8267â€¦â€¦ï¼‰ã€‚

2. **å¯è‡ªå®šä¹‰**

   - å¯ä»¥åœ¨ `ray.init()` æˆ–è€…å¯åŠ¨ head node æ—¶æŒ‡å®šç«¯å£ï¼š

   ```
   ray.init(include_dashboard=True, dashboard_port=12345)
   ```

---

**é—®é¢˜ï¼š**

æˆ‘æ‰“å¼€äº†http://127.0.0.1:8265/#/overviewï¼Œä½†æ˜¯å…·ä½“æ€ä¹ˆçœ‹å‘¢

---

**å›ç­”ï¼š**

å¥½çš„ï¼Œæˆ‘ç»™ä½ è¯¦ç»†è¯´æ˜ä¸€ä¸‹ Ray Dashboard çš„å„ä¸ªéƒ¨åˆ†ï¼Œä»¥åŠåœ¨è®­ç»ƒå¼ºåŒ–å­¦ä¹ ä»»åŠ¡æ—¶ï¼Œå¯ä»¥é‡ç‚¹å…³æ³¨å“ªäº›ä¿¡æ¯ã€‚

1ï¸âƒ£ æ¦‚è§ˆé¡µï¼ˆOverviewï¼‰

æ‰“å¼€ `http://127.0.0.1:8265/#/overview` åï¼Œçœ‹åˆ°çš„é€šå¸¸æ˜¯ **Overview** é¡µï¼Œä¸»è¦å±•ç¤ºé›†ç¾¤çŠ¶æ€ï¼š

- **Cluster resources**
  - CPU: å¯ç”¨/æ€»é‡
  - GPU: å¯ç”¨/æ€»é‡
  - Memory / Object Store Memory
- **Workers**
  - å½“å‰æ­£åœ¨è¿è¡Œçš„ Ray Worker æ•°é‡
  - æ¯ä¸ª worker çš„çŠ¶æ€ï¼š`idle` / `running` / `failed`
- **Tasks**
  - æ¯ä¸ªä»»åŠ¡çš„æ•°é‡ï¼ˆPendingã€Runningã€Failedï¼‰
- **Dashboard port**
  - æ˜¾ç¤º dashboard URLï¼ˆä½ å·²ç»è®¿é—®çš„æ˜¯ 8265ï¼‰

> âš ï¸ æ³¨æ„ï¼šå¦‚æœä½ åœ¨ WSL æˆ– CPU-only ç¯å¢ƒï¼ŒGPU ä¼šæ˜¾ç¤º 0ã€‚

2ï¸âƒ£ èµ„æºç›‘æ§ï¼ˆResources / Nodesï¼‰

ç‚¹å‡» **Nodes** é¡µé¢ï¼Œä½ èƒ½çœ‹åˆ°ï¼š

- æ¯ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰çš„ CPU / GPU / å†…å­˜ä½¿ç”¨æƒ…å†µ
- æ¯ä¸ªè¿›ç¨‹å¯¹åº”çš„ **PIDã€å†…å­˜å ç”¨ã€CPUå ç”¨**
- æ˜¯å¦æ˜¯ head nodeï¼ˆä¸»èŠ‚ç‚¹ï¼‰è¿˜æ˜¯ worker nodeï¼ˆå·¥ä½œèŠ‚ç‚¹ï¼‰

å¯¹äºä½ çš„é—®é¢˜ï¼š

> æˆ‘å¦‚ä½•çŸ¥é“æ¯ä¸ª worker çš„å†…å­˜å ç”¨ï¼Ÿ

åœ¨ **Nodes â†’ Workers** æˆ– **Processes** åˆ—é‡Œï¼Œæ¯ä¸ª worker éƒ½ä¼šæ˜¾ç¤ºå®ƒçš„ **å†…å­˜ä½¿ç”¨é‡**ï¼Œå¯ä»¥çœ‹åˆ°å•ä¸ª worker å ç”¨å¤šå°‘ MB æˆ– GBã€‚

3ï¸âƒ£ Tasks / Actors

ç‚¹å‡» **Tasks** æˆ– **Actors**ï¼š

- **Tasks**ï¼šæ˜¾ç¤ºæ­£åœ¨è¿è¡Œçš„ Ray ä»»åŠ¡
- **Actors**ï¼šæ˜¾ç¤ºä½ åˆ›å»ºçš„ **RolloutWorker / TrainWorker** ç­‰ actor
  - çŠ¶æ€ï¼ˆrunning / deadï¼‰
  - æ‰€å èµ„æºï¼ˆCPU / GPUï¼‰
  - é‡å¯æ¬¡æ•°ï¼ˆå¦‚æœ crashï¼Œä¼šæ˜¾ç¤º restart countï¼‰

4ï¸âƒ£ ç›‘æ§è®­ç»ƒæŒ‡æ ‡

å¦‚æœä½ åœ¨ Ray ä¸Šç»“åˆ **RLlib** æˆ–è‡ªå·±å†™çš„ PPO trainerï¼Œä½ å¯ä»¥ï¼š

- åœ¨è®­ç»ƒè„šæœ¬é‡Œæ‰“å°æ—¥å¿—æˆ– metrics
- å°†è®­ç»ƒæŒ‡æ ‡å‘é€åˆ° dashboardï¼ˆéœ€è¦ `ray.init(include_dashboard=True, logging_level="info")`ï¼‰
- åœ¨ **Metrics** é¡µé¢æŸ¥çœ‹ï¼š
  - lossã€reward
  - step count
  - rollout æ—¶å»¶

------

ğŸ’¡ **æ€»ç»“ä½ çš„ç”¨é€”**ï¼š

- CPU / GPU / Memory å ç”¨ â†’ Nodes é¡µé¢
- Worker çŠ¶æ€ â†’ Actors é¡µé¢
- ä»»åŠ¡é˜Ÿåˆ—å’Œç­‰å¾…çŠ¶æ€ â†’ Tasks é¡µé¢
- è®­ç»ƒæŒ‡æ ‡ â†’ Metrics / logï¼ˆéœ€è¦ä½ åœ¨ä»£ç é‡Œ exposeï¼‰

---

**é—®é¢˜ï¼š**

å¯æ˜¯æˆ‘æ‰“å¼€ä»¥åï¼Œé¦–é¡µé‡Œæ¯ä¸ªæ¨¡å—éƒ½å†™ç€ï¼š

```
Set up Prometheus and Grafana for better Ray Dashboard experience Time-series charts are hidden because either Prometheus or Grafana server is not detected. Follow these instructions to set them up and refresh this page.
```

---

**å›ç­”ï¼š**

å•Šï¼Œè¿™å°±è§£é‡Šä¸ºä»€ä¹ˆä½ çœ‹ä¸åˆ°å®æ—¶å›¾è¡¨äº†ã€‚Ray Dashboard é»˜è®¤å¯ä»¥æ˜¾ç¤º**å®æ—¶èµ„æºä½¿ç”¨çš„å›¾è¡¨**ï¼ˆCPU/GPU/Memory/ä»»åŠ¡æ•°éšæ—¶é—´å˜åŒ–ï¼‰ï¼Œä½†æ˜¯å®ƒä¾èµ– **Prometheus + Grafana** æ¥æ”¶é›†å’Œå¯è§†åŒ–æ—¶åºæ•°æ®ã€‚

1ï¸âƒ£ ä¸ºä»€ä¹ˆä¼šæ˜¾ç¤ºè¿™ä¸ªæç¤º

- Ray è‡ªå¸¦ Dashboardï¼Œä½†**æ—¶é—´åºåˆ—å›¾è¡¨ï¼ˆæŠ˜çº¿å›¾ï¼‰**éœ€è¦ Prometheus/Grafanaã€‚
- æ²¡æœ‰ Prometheus/Grafana æ—¶ï¼š
  - Dashboard è¿˜èƒ½æ˜¾ç¤ºèµ„æºæ€»é‡ã€èŠ‚ç‚¹åˆ—è¡¨ã€Worker çŠ¶æ€ç­‰é™æ€ä¿¡æ¯
  - ä½†æ˜¯æŠ˜çº¿å›¾ï¼ˆCPU/GPUå ç”¨éšæ—¶é—´å˜åŒ–ã€ä»»åŠ¡æ•°éšæ—¶é—´å˜åŒ–ï¼‰å°±ä¼šæ˜¾ç¤ºâ€œSet up Prometheus and Grafanaâ€¦â€

2ï¸âƒ£ è§£å†³æ–¹æ¡ˆ

æ–¹æ¡ˆ Aï¼šä¸è£… Prometheus/Grafana

- å¦‚æœä½ åªå…³å¿ƒï¼š
  - æ¯ä¸ªèŠ‚ç‚¹çš„ CPU/GPU/Memory ä½¿ç”¨æƒ…å†µ
  - Worker çŠ¶æ€
  - Tasks / Actors çŠ¶æ€
- **å¯ä»¥ç›´æ¥å¿½ç•¥è¿™ä¸ªæç¤º**ï¼ŒDashboard è¿˜æ˜¯æœ‰ç”¨çš„ã€‚

æ–¹æ¡ˆ Bï¼šè£… Prometheus + Grafana

- æŒ‰ Ray å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.ray.io/en/latest/ray-core/monitoring.html

- å¤§æ¦‚æµç¨‹ï¼š

  1. å®‰è£… Prometheusï¼š

     ```
     sudo apt install prometheus
     ```

  2. é…ç½® Prometheus æŠ“å– Ray metrics

     ```
     scrape_configs:
       - job_name: 'ray'
         static_configs:
           - targets: ['localhost:8888']  # Ray metrics endpoint
     ```

  3. å®‰è£… Grafanaï¼š

     ```
     sudo apt install grafana
     ```

  4. åœ¨ Grafana ä¸­æ·»åŠ  Prometheus æ•°æ®æº

  5. æ‰“å¼€ Ray Dashboardï¼Œä¼šæ˜¾ç¤ºæŠ˜çº¿å›¾

> âš ï¸ å¯¹äº WSLï¼Œè¿™ç§æ–¹æ¡ˆå¯èƒ½æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºè¦é…ç½®ç³»ç»ŸæœåŠ¡å’Œç«¯å£æ˜ å°„ã€‚
>  å¦‚æœåªæ˜¯è°ƒè¯• RL è®­ç»ƒï¼Œæ–¹æ¡ˆ A å®Œå…¨å¤Ÿç”¨ã€‚

æ€»ç»“ï¼š

- **é™æ€ä¿¡æ¯**ï¼ˆWorkerã€èŠ‚ç‚¹èµ„æºã€ä»»åŠ¡çŠ¶æ€ï¼‰é»˜è®¤å¯ç”¨ âœ…
- **å®æ—¶æŠ˜çº¿å›¾**ï¼ˆCPU/GPU/Memory éšæ—¶é—´å˜åŒ–ï¼‰éœ€è¦ Prometheus + Grafana â›”





# é—®é¢˜

## Rayæ˜¯æ€ä¹ˆçŸ¥é“ worker.step.remote()å·²ç»å®Œæˆçš„

å½“ä½ è°ƒç”¨ï¼š

```python
future = worker.step.remote(action)
```

- `future` æ˜¯ä¸€ä¸ª**Ray ObjectRef**ï¼ˆä¹Ÿå« Futureï¼‰ï¼Œè¡¨ç¤ºè¿™ä¸ªè¿œç¨‹ä»»åŠ¡çš„**å”¯ä¸€æ ‡è¯†ç¬¦**ã€‚
- Ray çš„**è°ƒåº¦å™¨**ä¼šæŠŠè¿™ä¸ªä»»åŠ¡åˆ†é…ç»™ **æŸä¸ª Workerï¼ˆè¿œç¨‹è¿›ç¨‹ï¼‰** æ‰§è¡Œã€‚

ç„¶åï¼ŒRay åœ¨åå°ä½¿ç”¨ **æ¶ˆæ¯é˜Ÿåˆ—** æœºåˆ¶ï¼ˆåŸºäº **GCSï¼ˆå…¨å±€æ§åˆ¶å­˜å‚¨ï¼‰å’Œè°ƒåº¦å™¨**ï¼‰ï¼Œä¸æ–­æ£€æŸ¥è¿™äº›ä»»åŠ¡çš„çŠ¶æ€ï¼š

1. **ä»»åŠ¡åˆšè¢«æäº¤** â†’ `future` å¤„äº**æœªå®Œæˆ**çŠ¶æ€ã€‚
2. **ä»»åŠ¡æ‰§è¡Œä¸­** â†’ `future` ä»ç„¶**æœªå®Œæˆ**ã€‚
3. **ä»»åŠ¡æ‰§è¡Œå®Œæ¯•** â†’ `future` å˜ä¸º**å·²å®Œæˆ**ï¼Œç»“æœå­˜å…¥ **Ray çš„å¯¹è±¡å­˜å‚¨ï¼ˆObject Storeï¼‰**ã€‚

å½“ä½ è°ƒç”¨ï¼š

```python
ready_tasks, _ = ray.wait(list(tasks.keys()), num_returns=1)
```

Ray ä¼šï¼š

1. éå† `tasks.keys()` é‡Œçš„æ‰€æœ‰ Futureï¼ˆæ­£åœ¨è¿è¡Œçš„ `worker.step.remote()`ï¼‰ã€‚
2. åœ¨**åå°ä¸æ–­è½®è¯¢**è¿™äº› Futureï¼Œæ£€æŸ¥å“ªäº›å·²ç»å®Œæˆã€‚
3. åªè¦**æœ‰ num_returns=1 ä¸ªä»»åŠ¡å®Œæˆ**ï¼Œå°±ç«‹åˆ»è¿”å›è¿™ä¸ªä»»åŠ¡çš„ Futureï¼Œä¸ä¼šç­‰å…¶ä»–ä»»åŠ¡ã€‚

**ray.wait() vs ray.get()**

| æ–¹æ³•                             | ä½œç”¨                                        | æ˜¯å¦é˜»å¡ä¸»çº¿ç¨‹               |
| -------------------------------- | ------------------------------------------- | ---------------------------- |
| `ray.wait([...], num_returns=1)` | **ç­‰å¾…æœ€å°‘ 1 ä¸ªä»»åŠ¡å®Œæˆ**ï¼Œä½†ä¸ä¼šç­‰æ‰€æœ‰ä»»åŠ¡ | **ä¸ä¼šé˜»å¡**ï¼Œä¸»çº¿ç¨‹ç»§ç»­è¿è¡Œ |
| `ray.get(futures)`               | **è·å–æ‰€æœ‰ä»»åŠ¡çš„ç»“æœ**ï¼Œå¿…é¡»ç­‰æ‰€æœ‰ä»»åŠ¡å®Œæˆ  | **ä¼šé˜»å¡**ï¼Œç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆ |

**ray.wait() é€‚åˆå¼‚æ­¥å¹¶è¡Œ**ï¼Œä¸ä¼šå¡ä½æ…¢çš„ä»»åŠ¡ï¼Œæé«˜è®­ç»ƒæ•ˆç‡ï¼

## ray.wait()çš„åŸç†

å‰é¢ä½ æåˆ°äº†ï¼š

> 1ã€ä»»åŠ¡æ‰§è¡Œå®Œæ¯• â†’ future å˜ä¸ºå·²å®Œæˆï¼Œç»“æœå­˜å…¥ Ray çš„å¯¹è±¡å­˜å‚¨ï¼ˆObject Storeï¼‰ã€‚
> 2ã€waitåœ¨åå°ä¸æ–­è½®è¯¢è¿™äº› Futureï¼Œæ£€æŸ¥å“ªäº›å·²ç»å®Œæˆã€‚

æˆ‘çš„ç†è§£ï¼š

> ä»ä½ æåˆ°çš„1å’Œ2ä¸¤ç‚¹ï¼Œæˆ‘æ¨æ–­å‡ºï¼Œwaitä¼šä¸æ–­æŸ¥è¯¢ Ray çš„å¯¹è±¡å­˜å‚¨ï¼ˆObject Storeï¼‰ä¸­æ˜¯å¦æœ‰listä¸­çš„workeræ ‡è®°ï¼Œå¦‚æœæœ‰ï¼Œé‚£å°±è¯´æ˜å®Œæˆäº†ï¼Ÿ

æ˜¯çš„ï¼Œä½ çš„ç†è§£åŸºæœ¬æ­£ç¡®ï¼Ray çš„ `ray.wait()` é€šè¿‡**æ£€æŸ¥ Object Storeï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰**ï¼Œåˆ¤æ–­å“ªäº›ä»»åŠ¡å·²ç»å®Œæˆï¼Œæµç¨‹å¦‚ä¸‹ï¼š

**æ·±å…¥è§£æ ray.wait() æœºåˆ¶**

1. **ä»»åŠ¡æäº¤**ï¼š

   ```python
   future = worker.step.remote(action)
   ```

   - `future` æ˜¯ä¸€ä¸ª **ObjectRef**ï¼Œè¡¨ç¤ºè¿™ä¸ªä»»åŠ¡çš„å”¯ä¸€æ ‡è¯†ã€‚
   - ä»»åŠ¡è¢«æ´¾å‘åˆ°æŸä¸ª **Worker è¿›ç¨‹** å¤„ç†ã€‚

2. **ä»»åŠ¡æ‰§è¡Œä¸­**ï¼š

   - Worker è¿è¡Œ `step()` æ–¹æ³•ï¼Œå¯èƒ½éœ€è¦ **ä¸åŒæ—¶é—´** æ‰èƒ½å®Œæˆã€‚
   - è¿™æ—¶ï¼ŒObject Store é‡Œ**è¿˜æ²¡æœ‰**å¯¹åº”çš„ç»“æœï¼Œ`future` å¤„äº**æœªå®Œæˆ**çŠ¶æ€ã€‚

3. **ä»»åŠ¡æ‰§è¡Œå®Œæ¯•**ï¼š

   - Worker è®¡ç®—å®Œ `step()` ç»“æœï¼ŒæŠŠ `(obs, reward, done)` å­˜å…¥ **Object Store**ã€‚
   - æ­¤æ—¶ `future` å˜ä¸º **å·²å®ŒæˆçŠ¶æ€**ï¼ŒRay è®°å½•å®ƒå·²ç»å®Œæˆã€‚

4. **ray.wait() æ£€æµ‹ä»»åŠ¡å®Œæˆ**ï¼š

   ```python
   ready_tasks, _ = ray.wait(list(tasks.keys()), num_returns=1)
   ```

   - `ray.wait()` åœ¨åå°**è½®è¯¢ Object Store**ï¼Œæ£€æŸ¥ `tasks.keys()`ï¼ˆæ‰€æœ‰ Futureï¼‰å¯¹åº”çš„ç»“æœæ˜¯å¦å·²ç»å­˜å…¥ Object Storeã€‚
   - åªè¦æœ‰ **è‡³å°‘ 1 ä¸ª** Future çš„ç»“æœ**å¯ç”¨**ï¼Œå®ƒå°±ä¼šç«‹å³è¿”å›è¯¥ä»»åŠ¡çš„ Futureï¼Œä¸ç­‰å…¶ä»–ä»»åŠ¡ã€‚

**ä½ çš„æ¨æ–­å’Œ Ray å†…éƒ¨æµç¨‹**

ä½ çš„æ¨æ–­ï¼š

> `ray.wait()` ä¼šä¸æ–­æŸ¥è¯¢ **Ray çš„å¯¹è±¡å­˜å‚¨ï¼ˆObject Storeï¼‰** æ˜¯å¦æœ‰ `list` ä¸­çš„ `worker` æ ‡è®°ï¼Œå¦‚æœæœ‰ï¼Œé‚£å°±è¯´æ˜å®Œæˆäº†ï¼Ÿ

**æ˜¯çš„ï¼ŒåŸºæœ¬æ­£ç¡®ï¼**

- `ray.wait()` æŸ¥è¯¢çš„å…¶å®æ˜¯ **Future å¯¹åº”çš„ ObjectRef æ˜¯å¦æœ‰å¯ç”¨ç»“æœ**ã€‚
- ä¸€æ—¦æŸä¸ª `ObjectRef` **åœ¨ Object Store é‡Œæ‰¾åˆ°äº†ç»“æœ**ï¼ŒRay å°±çŸ¥é“è¿™ä¸ªä»»åŠ¡å®Œæˆäº†ã€‚

**ray.wait() vs ray.get()**

| æ–¹æ³•         | æ£€æŸ¥æ–¹å¼                  | æ˜¯å¦ç­‰æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Ÿ     | æ˜¯å¦å¹¶è¡Œé«˜æ•ˆï¼Ÿ   |
| ------------ | ------------------------- | ------------------------ | ---------------- |
| `ray.wait()` | **å¼‚æ­¥è½®è¯¢ Object Store** | âŒ åªç­‰ **éƒ¨åˆ†** ä»»åŠ¡å®Œæˆ | âœ… é€‚åˆå¼‚æ­¥å¹¶è¡Œ   |
| `ray.get()`  | **ç›´æ¥è¯»å– Object Store** | âœ… **å¿…é¡»ç­‰å…¨éƒ¨ä»»åŠ¡å®Œæˆ** | âŒ å¯èƒ½å¡ä½æ…¢ä»»åŠ¡ |

**Ray é€šè¿‡ Object Store è®© ray.wait() å˜å¾—é«˜æ•ˆï¼Œé¿å…ç­‰å¾…æ…¢ä»»åŠ¡ï¼Œæå‡å¹¶è¡Œæ•ˆç‡ï¼**

## Object Storeå­˜å‚¨æ•°æ®æ ¼å¼

ä½ æåˆ°äº†ï¼š

> 1ã€Worker è®¡ç®—å®Œ step() ç»“æœï¼ŒæŠŠ (obs, reward, done) å­˜å…¥ Object Storeã€‚
> 2ã€ray.wait() æŸ¥è¯¢çš„å…¶å®æ˜¯ Future å¯¹åº”çš„ ObjectRef æ˜¯å¦æœ‰å¯ç”¨ç»“æœã€‚

é‚£æˆ‘ç†è§£ï¼š

> Object Storeå­˜çš„æ˜¯ç±»ä¼¼ä¸€ä¸ªdictå­—å…¸ï¼Œå³{Future å¯¹åº”çš„ ObjectRef:  (obs, reward, done)}ï¼Œå®é™…æ˜¯æˆ‘ç†è§£çš„è¿™æ ·å—ï¼Ÿ

ä½ çš„ç†è§£**åŸºæœ¬æ­£ç¡®**ï¼ŒObject Store ç¡®å®**ç±»ä¼¼ä¸€ä¸ªå­—å…¸**ï¼Œä½†å®ƒå¹¶ä¸æ˜¯çœŸæ­£çš„ Python `dict`ï¼Œè€Œæ˜¯ä¸€ä¸ª **åˆ†å¸ƒå¼çš„å¯¹è±¡å­˜å‚¨ç³»ç»Ÿ**ï¼Œå¯ä»¥è·¨è¿›ç¨‹ã€è·¨æœºå™¨è®¿é—®ã€‚

**Object Store çš„æ•°æ®ç»“æ„ï¼ˆç±»æ¯” Python dictï¼‰**

è™½ç„¶ Ray çš„ Object Store ä¸æ˜¯ä¸¥æ ¼çš„ Python `dict`ï¼Œä½†å®ƒçš„ä½œç”¨ç±»ä¼¼ï¼š

```python
ObjectStore = {
    ObjectRef1: (obs1, reward1, done1),
    ObjectRef2: (obs2, reward2, done2),
    ObjectRef3: (obs3, reward3, done3),
}
```

- **Keyï¼ˆé”®ï¼‰** â†’ `ObjectRef`ï¼ˆç±»ä¼¼äº Futureï¼‰
- **Valueï¼ˆå€¼ï¼‰** â†’ ä»»åŠ¡æ‰§è¡Œç»“æœï¼ˆå¦‚ `(obs, reward, done)`ï¼‰

å½“ `ray.wait([ObjectRef1, ObjectRef2])` æ‰§è¡Œæ—¶ï¼š

- Ray **æŸ¥è¯¢ Object Store**ï¼Œçœ‹ `ObjectRef1` å’Œ `ObjectRef2` æ˜¯å¦æœ‰å€¼ã€‚ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿåº”è¯¥æ˜¯æœ‰keyå•Š
- å¦‚æœ `ObjectRef1` **æœ‰å€¼äº†**ï¼Œå°±è¿”å›å®ƒï¼Œ`ObjectRef2` è¿˜æ²¡å®Œæˆå°±ä¸ç®¡ã€‚

**Object Store å’Œ Python dict çš„å…³é”®åŒºåˆ«**

| ç‰¹æ€§       | Python `dict`       | Ray Object Store                      |
| ---------- | ------------------- | ------------------------------------- |
| ä½œç”¨èŒƒå›´   | ä»…é™äº **å½“å‰è¿›ç¨‹** | **è·¨è¿›ç¨‹ / åˆ†å¸ƒå¼**ï¼ˆè¿›ç¨‹é—´å…±äº«æ•°æ®ï¼‰ |
| è®¿é—®æ–¹å¼   | ç›´æ¥è¯»å–            | é€šè¿‡ `ObjectRef` æŸ¥è¯¢                 |
| ä»»åŠ¡å®Œæˆå‰ | ç›´æ¥å­˜å–æ•°æ®        | ä»»åŠ¡æœªå®Œæˆæ—¶ï¼Œæ•°æ®**ä¸å¯è®¿é—®**        |
| ä»»åŠ¡å®Œæˆå | ç«‹å³å¯è¯»            | `ray.get(ObjectRef)` è·å–æ•°æ®         |

**å…³é”®ç‚¹ï¼š**

1. **Object Store å…è®¸æ•°æ®åœ¨å¤šä¸ªè¿›ç¨‹/æœºå™¨ä¹‹é—´å…±äº«ï¼Œè€Œä¸å¤åˆ¶**ï¼Œæé«˜æ•ˆç‡ã€‚
2. **ray.wait() è½®è¯¢è¿™ä¸ªå­˜å‚¨ï¼Œæ£€æŸ¥å“ªäº› ObjectRef å·²ç»æœ‰æ•°æ®**ã€‚

**æ·±å…¥ç†è§£ ray.get()**

å½“ä½ æ‰§è¡Œï¼š

```python
result = ray.get(ObjectRef1)
```

- Ray ä¼šæŸ¥è¯¢ **Object Store**ï¼Œå¦‚æœ `ObjectRef1` è¿˜**æ²¡æœ‰ç»“æœ**ï¼Œå°±ä¼š**é˜»å¡ç­‰å¾…**ã€‚
- ä¸€æ—¦ `ObjectRef1` **æœ‰æ•°æ®**ï¼Œå°±æŠŠ `(obs, reward, done)` **å–å‡ºæ¥** è¿”å›ã€‚

è€Œ `ray.wait()` æ˜¯**å¼‚æ­¥æ£€æŸ¥**ï¼Œä¸ä¼šå¡ä½ä¸»è¿›ç¨‹ã€‚

**æ€»ç»“**

ä½ çš„ç†è§£æ–¹å‘æ˜¯å¯¹çš„ï¼ŒObject Store **ç±»ä¼¼ä¸€ä¸ª dict**ï¼Œä½†å®ƒæ˜¯**åˆ†å¸ƒå¼å­˜å‚¨**ï¼Œæ•°æ®çš„è®¿é—®æ–¹å¼ä¹Ÿä¸ä¸€æ ·ã€‚`ray.wait()` **æ£€æŸ¥ Object Store é‡Œå“ªäº› ObjectRef å·²ç»æœ‰ç»“æœ**ï¼Œä»è€Œå®ç°å¼‚æ­¥å¹¶è¡Œå¤„ç†ã€‚

## Object-Storeä¸­å­˜å‚¨çš„ç»“æ„è¢«ray.get()åä¼šè¢«åˆ é™¤å—

æˆ‘çš„é—®é¢˜ï¼š

> é‚£åœ¨ Object Storeä¸­å­˜å‚¨çš„dictç»“æœï¼Œä¸€æ—¦è¢«ray.get()åï¼Œæ˜¯ä¸æ˜¯å°±ä¼šä» Object Storeå­˜å‚¨ä¸­åˆ é™¤ï¼Ÿ

**ä¸æ˜¯çš„ï¼** åœ¨ **Ray çš„ Object Store** ä¸­ï¼Œ**å¯¹è±¡ä¸ä¼šå› ä¸º ray.get() è¢«è·å–åå°±è‡ªåŠ¨åˆ é™¤**ï¼Œå®ƒä»ç„¶ä¼šç»§ç»­å­˜å‚¨åœ¨é‚£é‡Œï¼Œç›´åˆ°æ»¡è¶³**ä¸€å®šçš„åˆ é™¤æ¡ä»¶**ã€‚

**ray.get() åªæ˜¯è¯»å–ï¼Œä¸ä¼šåˆ é™¤ Object Store çš„æ•°æ®**

å½“ä½ è°ƒç”¨ï¼š

```python
result = ray.get(obj_ref)
```

- **Ray åªæ˜¯ä» Object Store é‡Œè¯»å–æ•°æ®ï¼Œå¹¶ä¸ä¼šåˆ é™¤å®ƒã€‚**
- **ç›¸åŒçš„ obj_refï¼Œä½ å¯ä»¥å¤šæ¬¡ ray.get()ï¼Œéƒ½èƒ½è·å–ç›¸åŒçš„ç»“æœã€‚**

æ¢å¥è¯è¯´ï¼Œ**Object Store ç±»ä¼¼äºä¸€ä¸ªç¼“å­˜ï¼Œæ•°æ®é»˜è®¤ä¸ä¼šç«‹åˆ»åˆ é™¤**ã€‚

**é‚£ Object Store é‡Œçš„æ•°æ®ä»€ä¹ˆæ—¶å€™ä¼šåˆ é™¤ï¼Ÿ**

Ray é‡‡ç”¨**è‡ªåŠ¨åƒåœ¾å›æ”¶**ï¼ˆGarbage Collection, GCï¼‰æœºåˆ¶ï¼Œå½“**æŸä¸ªå¯¹è±¡çš„ ObjectRefï¼ˆå³ obj_refï¼‰ä¸å†è¢«å¼•ç”¨æ—¶ï¼ŒRay å¯èƒ½ä¼šæ¸…ç†å®ƒ**ã€‚ä»¥ä¸‹å‡ ç§æƒ…å†µä¼šå¯¼è‡´æ•°æ®åˆ é™¤ï¼š

**æ²¡æœ‰ä»»ä½• Python å˜é‡å¼•ç”¨ obj_ref**

å¦‚æœ `obj_ref` å˜é‡åœ¨ Python ä»£ç ä¸­è¢«åˆ é™¤ï¼Œæˆ–è€…è¶…å‡ºäº†ä½œç”¨åŸŸï¼ŒRay **å¯èƒ½ä¼šè‡ªåŠ¨é‡Šæ”¾**å®ƒçš„å­˜å‚¨ï¼š

```python
obj_ref = worker.step.remote()  # ç”Ÿæˆä¸€ä¸ª ObjectRef
result = ray.get(obj_ref)  # è·å–æ•°æ®
del obj_ref  # æ˜¾å¼åˆ é™¤å¼•ç”¨ï¼ŒRay å¯èƒ½å›æ”¶å¯¹è±¡
```

**å½“ obj_ref è¢« del æˆ–è€…è¶…å‡ºä½œç”¨åŸŸæ—¶ï¼ŒRay å¯èƒ½ä¼šæ¸…ç† Object Store é‡Œçš„æ•°æ®ã€‚**

**Object Store å†…å­˜ä¸è¶³**

- **Ray é‡‡ç”¨ LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç­–ç•¥**ï¼Œå¦‚æœ Object Store çš„**å†…å­˜å¿«æ»¡äº†**ï¼ŒRay ä¼š**è‡ªåŠ¨åˆ é™¤æœ€è€çš„å¯¹è±¡**ã€‚
- **ä½ å¯ä»¥è°ƒæ•´ object_store_memory å‚æ•°** æ¥æ‰©å¤§ Object Store çš„å†…å­˜ã€‚

**æ˜¾å¼åˆ é™¤**

ä½ å¯ä»¥ä½¿ç”¨ `ray.internal.free()`ï¼ˆæˆ–è€… `ray.experimental.internal_kv.del()`ï¼‰æ¥**å¼ºåˆ¶åˆ é™¤**å­˜å‚¨å¯¹è±¡ï¼š

```python
ray.internal.free([obj_ref])  # ç«‹å³åˆ é™¤ Object Store é‡Œçš„æ•°æ®
```

**å®éªŒéªŒè¯**

ä½ å¯ä»¥å°è¯•ä»¥ä¸‹ä»£ç ï¼š

```python
import ray
ray.init()

@ray.remote
def foo():
    return [1, 2, 3]

obj_ref = foo.remote()
print(ray.get(obj_ref))  # è¯»å–ç»“æœ

del obj_ref  # åˆ é™¤ Python å˜é‡
print(ray.get(obj_ref))  # âŒ è¿™ä¼šæŠ¥é”™ï¼Œå› ä¸º obj_ref å·²è¢«å›æ”¶
```

å½“ `obj_ref` è¢«åˆ é™¤åï¼Œ**Object Store é‡Œçš„æ•°æ®ä¹Ÿå¯èƒ½ä¼šè¢«å›æ”¶**ï¼Œ`ray.get(obj_ref)` å°±ä¼šæŠ¥é”™ã€‚

**ç»“è®º**

1. **ray.get() åªæ˜¯è¯»å– Object Storeï¼Œä¸ä¼šåˆ é™¤æ•°æ®**ï¼Œä½ å¯ä»¥å¤šæ¬¡ `ray.get(obj_ref)` è·å–ç›¸åŒçš„ç»“æœã€‚
2. **æ•°æ®ä¼šè¢« Ray çš„ GC è‡ªåŠ¨æ¸…ç†**ï¼Œå½“ `obj_ref` å˜é‡è¢«åˆ é™¤æˆ–è¶…å‡ºä½œç”¨åŸŸæ—¶ï¼ŒObject Store å¯èƒ½å›æ”¶å®ƒã€‚
3. **Object Store é‡‡ç”¨ LRU ç­–ç•¥**ï¼Œå½“å†…å­˜ä¸è¶³æ—¶ï¼ŒRay å¯èƒ½è‡ªåŠ¨åˆ é™¤æœ€æ—§çš„æ•°æ®ã€‚
4. **å¯ä»¥æ‰‹åŠ¨åˆ é™¤å¯¹è±¡**ï¼ˆ`ray.internal.free([obj_ref])`ï¼‰ï¼Œå¼ºåˆ¶æ¸…ç†å­˜å‚¨ã€‚

æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³ç¡®ä¿æ•°æ®ä¸€ç›´åœ¨ Object Store é‡Œï¼Œéœ€è¦**ä¿å­˜ obj_ref å¹¶ç¡®ä¿å®ƒä¸ä¼šè¢«åˆ é™¤**ã€‚



æˆ‘çš„é—®é¢˜ï¼š

> obj_ref = worker.step.remote()  # ç”Ÿæˆä¸€ä¸ª ObjectRef
>
> result = ray.get(obj_ref)  # è·å–æ•°æ®
>
> del obj_ref  # æ˜¾å¼åˆ é™¤å¼•ç”¨ï¼ŒRay å¯èƒ½å›æ”¶å¯¹è±¡
>
> æˆ‘åªæ˜¯åœ¨pythonä¸­æŠŠobj_refåˆ é™¤äº†ï¼Œrayä¸­æ˜¯æ€ä¹ˆçŸ¥é“çš„å‘¢

å½“ä½ åœ¨ Python ä¸­ä½¿ç”¨ `del obj_ref` æ˜¾å¼åˆ é™¤ä¸€ä¸ª `ObjectRef` æ—¶ï¼Œå®é™…ä¸Šåªæ˜¯åˆ é™¤äº† Python å±‚é¢ä¸Šçš„å¯¹è¿™ä¸ª `ObjectRef` çš„å¼•ç”¨ï¼Œå¹¶æ²¡æœ‰ç›´æ¥åˆ é™¤ Ray å†…éƒ¨çš„å¯¹è±¡ã€‚åœ¨ Ray ä¸­ï¼ŒRay çš„å¯¹è±¡å­˜å‚¨ï¼ˆObject Storeï¼‰æ˜¯åŸºäºå¼•ç”¨è®¡æ•°çš„æœºåˆ¶è¿›è¡Œåƒåœ¾å›æ”¶çš„ï¼Œå…·ä½“çš„è¡Œä¸ºå¦‚ä¸‹ï¼š

**1. å¼•ç”¨è®¡æ•°æœºåˆ¶**

Ray ä¼šè·Ÿè¸ªæ¯ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰ã€‚æ¯å½“æœ‰ä¸€ä¸ªæ–°çš„å¼•ç”¨æŒ‡å‘è¿™ä¸ªå¯¹è±¡ï¼Œå¼•ç”¨è®¡æ•°å°±ä¼šå¢åŠ ï¼›å½“å¼•ç”¨è¢«åˆ é™¤æˆ–è¶…å‡ºä½œç”¨åŸŸæ—¶ï¼Œå¼•ç”¨è®¡æ•°ä¼šå‡å°‘ã€‚å½“ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°é™ä¸º 0 æ—¶ï¼ŒRay ä¼šè®¤ä¸ºè¿™ä¸ªå¯¹è±¡ä¸å†è¢«ä½¿ç”¨ï¼Œå¯ä»¥è¢«å›æ”¶ã€‚

å› æ­¤ï¼Œå³ä½¿ä½ åœ¨ Python ä¸­ä½¿ç”¨ `del obj_ref` åˆ é™¤äº†å¯¹ `ObjectRef` çš„å¼•ç”¨ï¼ŒRay å†…éƒ¨ä»ç„¶ä¼šæ ¹æ®å¯¹è±¡çš„å¼•ç”¨è®¡æ•°åˆ¤æ–­è¿™ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›æ”¶ã€‚å¦‚æœåœ¨åˆ é™¤å¼•ç”¨ä¹‹åï¼Œè¿˜æœ‰å…¶ä»–çš„åœ°æ–¹ï¼ˆæ¯”å¦‚å…¶ä»–çš„ `ray.get()` æˆ–å…¶ä»–çš„ `ObjectRef` å¼•ç”¨ï¼‰ä»ç„¶å¼•ç”¨ç€è¿™ä¸ªå¯¹è±¡ï¼ŒRay å°±ä¸ä¼šå›æ”¶å®ƒã€‚

**2. del obj_ref å¯¹ Ray çš„å½±å“**

- `del obj_ref` åªä¼šç§»é™¤ Python ä»£ç ä¸­çš„å˜é‡ `obj_ref`ï¼Œå®ƒä¸ä¼šç›´æ¥å½±å“ Ray çš„å¯¹è±¡å­˜å‚¨ä¸­çš„å†…å®¹ã€‚
- Ray å†…éƒ¨çš„å¯¹è±¡ï¼ˆæ¯”å¦‚å­˜å‚¨ `step()` è¿”å›çš„ç»“æœï¼‰ä¼šç»§ç»­å­˜åœ¨ï¼Œç›´åˆ°æ²¡æœ‰å…¶ä»–åœ°æ–¹æŒæœ‰è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼ŒRay æ‰ä¼šé€šè¿‡å…¶åƒåœ¾å›æ”¶æœºåˆ¶å°†å¯¹è±¡ä»å¯¹è±¡å­˜å‚¨ä¸­åˆ é™¤ã€‚

**3. Ray å¯¹è±¡å­˜å‚¨å’Œå›æ”¶**

å½“ä½ é€šè¿‡ `ray.get(obj_ref)` è·å–å¯¹è±¡æ—¶ï¼ŒRay ä¼šåœ¨åå°æ£€æŸ¥å¯¹è±¡æ˜¯å¦å·²ç»è¢«è®¡ç®—å®Œæˆï¼Œå¹¶è¿”å›è®¡ç®—ç»“æœã€‚Ray ä¼šå°†è¿™ä¸ªå¯¹è±¡çš„ç»“æœå­˜å‚¨åœ¨å¯¹è±¡å­˜å‚¨ä¸­ï¼Œç›´åˆ°æ²¡æœ‰ä»»ä½•å¼•ç”¨æŒ‡å‘å®ƒæ—¶ï¼ŒRay æ‰ä¼šæ¸…é™¤è¿™ä¸ªå¯¹è±¡å¹¶é‡Šæ”¾å†…å­˜ã€‚

**ç®€è€Œè¨€ä¹‹**

- `del obj_ref` åˆ é™¤çš„æ˜¯ä½ åœ¨ Python ä¸­çš„å¼•ç”¨ï¼ŒRay å¹¶ä¸ä¼šç«‹å³å›æ”¶è¿™ä¸ªå¯¹è±¡ã€‚
- Ray ä¼šä¾èµ–å…¶å†…éƒ¨çš„å¼•ç”¨è®¡æ•°æœºåˆ¶æ¥å†³å®šä½•æ—¶å›æ”¶å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰å…¶ä»–å¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œå…¶ä»–çš„ `ObjectRef`ï¼‰ï¼ŒRay æ‰ä¼šå›æ”¶å®ƒã€‚

**æ€»ç»“**

Ray ä¼šè·Ÿè¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå¹¶åœ¨å¯¹è±¡ä¸å†è¢«å¼•ç”¨æ—¶æ¸…é™¤å®ƒã€‚å³ä½¿ä½ åœ¨ Python ä¸­åˆ é™¤äº† `ObjectRef` çš„å¼•ç”¨ï¼Œåªè¦ Ray å†…éƒ¨ä»ç„¶æœ‰å…¶ä»–åœ°æ–¹æŒæœ‰å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼Œå®ƒå°±ä¸ä¼šè¢«å›æ”¶ã€‚



æˆ‘çš„é—®é¢˜ï¼š

> å¦‚æœä¸åˆ é™¤çš„è¯ï¼Œé‚£å†æ¬¡è°ƒç”¨worker.step.remoteï¼ŒObject StoreåŸæ¥è¯¥workå¯¹åº”çš„dictçš„valueæ˜¯å¦ä¼šè¢«æ›´æ–°ï¼Ÿ

**ä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼**

æ¯æ¬¡ä½ è°ƒç”¨ `worker.step.remote()`ï¼Œ**éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ ObjectRefï¼Œä¸ä¼šè¦†ç›–ä¹‹å‰çš„å€¼**ã€‚Object Store é‡Œçš„æ•°æ®æ˜¯**ä¸å¯å˜çš„**ï¼ˆImmutableï¼‰ï¼Œä¸ä¼šå› ä¸ºä½ å†æ¬¡è°ƒç”¨ `worker.step.remote()` è€Œè‡ªåŠ¨æ›´æ–°æ—§çš„å€¼ã€‚

```python
import ray
ray.init()

@ray.remote
class Worker:
    def step(self):
        return "New Data"

worker = Worker.remote()

# ç¬¬ä¸€æ¬¡è°ƒç”¨ step
obj_ref1 = worker.step.remote()
print(ray.get(obj_ref1))  # ç»“æœï¼š"New Data"

# å†æ¬¡è°ƒç”¨ step
obj_ref2 = worker.step.remote()
print(ray.get(obj_ref2))  # ç»“æœä»ç„¶æ˜¯ï¼š"New Data"

# æ£€æŸ¥ä¸¤ä¸ª ObjectRef æ˜¯å¦ç›¸åŒ
print(obj_ref1 == obj_ref2)  # ç»“æœï¼šFalseï¼ˆä¸åŒçš„ ObjectRefï¼‰
```

obj_ref1 == obj_ref2ä¸ºä»€ä¹ˆèƒ½æ¯”è¾ƒï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ

**è§‚å¯Ÿåˆ°ï¼š**

- **æ¯æ¬¡ step.remote() éƒ½ä¼šè¿”å›æ–°çš„ ObjectRef**ï¼ˆå³ `obj_ref1` å’Œ `obj_ref2` æ˜¯ä¸åŒçš„ï¼‰ã€‚
- **Object Store é‡Œä¸ä¼šè¦†ç›–åŸæ¥çš„å€¼ï¼Œè€Œæ˜¯åˆ›å»ºæ–°çš„å­˜å‚¨å¯¹è±¡**ã€‚

## ä»€ä¹ˆæ˜¯obj_ref

`obj_ref` æ˜¯ **Object Reference** çš„ç®€ç§°ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ä¸ª**æŒ‡å‘æŸä¸ªå­˜å‚¨åœ¨ Ray Object Store ä¸­æ•°æ®çš„å¼•ç”¨**ã€‚

åœ¨ Ray ä¸­ï¼Œè®¡ç®—ä»»åŠ¡ï¼ˆæ¯”å¦‚è°ƒç”¨ `worker.step.remote()`ï¼‰ä¼šç”Ÿæˆä¸€ä¸ª **ObjectRef**ï¼Œè¿™ä¸ª **ObjectRef** å°±æ˜¯ä½ ç”¨æ¥è®¿é—®è®¡ç®—ç»“æœçš„â€œå¥æŸ„â€ã€‚é€šè¿‡ `ray.get(obj_ref)`ï¼Œä½ å¯ä»¥è·å–ä»»åŠ¡æ‰§è¡Œçš„ç»“æœã€‚

**å¦‚ä½•ç†è§£ obj_refï¼Ÿ**

ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸º **æŒ‡å‘ Ray ä¸­æ•°æ®çš„æŒ‡é’ˆ**ï¼Œå®ƒå¹¶ä¸å­˜å‚¨æ•°æ®æœ¬èº«ï¼Œè€Œæ˜¯æŒ‡å‘å­˜å‚¨æ•°æ®çš„ä½ç½®ã€‚Ray ä½¿ç”¨è¿™äº›å¼•ç”¨æ¥ç®¡ç†ä»»åŠ¡ç»“æœå’Œå¯¹è±¡å­˜å‚¨ã€‚

**å·¥ä½œæµç¨‹ï¼š**

1. å½“ä½ è°ƒç”¨ä¸€ä¸ª Ray è¿œç¨‹æ–¹æ³•ï¼ˆæ¯”å¦‚ `worker.step.remote()`ï¼‰æ—¶ï¼ŒRay ä¼šæ‰§è¡Œè¯¥æ–¹æ³•å¹¶è¿”å›ä¸€ä¸ª `obj_ref`ï¼Œè¡¨ç¤ºè¿™ä¸ªä»»åŠ¡çš„ç»“æœã€‚

   ```python
   obj_ref = worker.step.remote()  # è¿™è¿”å›çš„æ˜¯ä¸€ä¸ª ObjectRef
   ```

2. è¯¥ `obj_ref` åªæ˜¯ä¸€ä¸ªæŒ‡å‘ç»“æœæ•°æ®çš„å¼•ç”¨ã€‚**ä»»åŠ¡æ‰§è¡Œçš„ç»“æœä¼šå­˜å‚¨åœ¨ Ray çš„ Object Store ä¸­ï¼Œè€Œ obj_ref åˆ™æ˜¯è®¿é—®è¿™äº›ç»“æœçš„å”¯ä¸€æ ‡è¯†ç¬¦**ã€‚

3. ä½ å¯ä»¥é€šè¿‡ `ray.get(obj_ref)` è·å–æ•°æ®ï¼Œè¿™æ—¶ Ray ä¼šå» Object Store ä¸­æ‰¾åˆ°å¯¹åº”çš„ç»“æœå¹¶è¿”å›ç»™ä½ ã€‚

   ```python
   result = ray.get(obj_ref)  # è·å–å¯¹è±¡å­˜å‚¨ä¸­çš„æ•°æ®
   ```

**ç®€å•ç¤ºä¾‹ï¼š**

```python
import ray

ray.init()

@ray.remote
class Worker:
    def step(self):
        return "Hello from worker!"

worker = Worker.remote()

# è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼Œå¾—åˆ°ä¸€ä¸ª ObjectRef
obj_ref = worker.step.remote()

# ä½¿ç”¨ ObjectRef è·å–æ‰§è¡Œç»“æœ
result = ray.get(obj_ref)
print(result)  # è¾“å‡º: "Hello from worker!"
```

**æ€»ç»“ï¼š**

- `obj_ref` æ˜¯æŒ‡å‘ **Ray Object Store** ä¸­çš„ä»»åŠ¡ç»“æœçš„å¼•ç”¨ã€‚
- å®ƒä¸åŒ…å«ä»»åŠ¡çš„å®é™…æ•°æ®ï¼Œè€Œæ˜¯ Ray ç”¨æ¥è¿½è¸ªä»»åŠ¡è¿›åº¦å’Œè·å–ç»“æœçš„æ ‡è¯†ç¬¦ã€‚
- é€šè¿‡ `ray.get(obj_ref)`ï¼Œä½ å¯ä»¥è·å–åˆ°æ•°æ®ï¼Œ`obj_ref` å°±åƒæ˜¯ä¸€ä¸ªæ•°æ®çš„â€œåœ°å€â€ã€‚

# åŸºäºRayå¹¶è¡Œé‡‡æ ·æ‰¹é‡æ¨ç†çš„å¼ºåŒ–å­¦ä¹ ä»£ç è§£æ

```python
import ray
import time
import numpy as np
from collections import deque

ray.init()

class Agent:
    def __init__(self):
        pass  # åˆå§‹åŒ–ç­–ç•¥ç½‘ç»œç­‰

    def choose_action(self, states):
        """æ‰¹é‡é€‰æ‹©åŠ¨ä½œ"""
        states = np.array(states)  # è½¬æ¢ä¸º NumPy æ•°ç»„ï¼Œæ–¹ä¾¿å¤„ç†
        return np.random.randint(4, size=len(states))  # è¿™é‡Œç”¨éšæœºåŠ¨ä½œï¼Œå®é™…ä¸­æ”¹æˆç¥ç»ç½‘ç»œæ‰¹é‡æ¨ç†

    def update(self, buffer):
        """è®­ç»ƒæ™ºèƒ½ä½“"""
        print(f"è®­ç»ƒ PPOï¼Œæ ·æœ¬æ•°ï¼š{len(buffer)}")
        buffer.clear()  # æ¸…ç©ºç»éªŒæ± ï¼Œç­‰å¾…ä¸‹æ¬¡æ”¶é›†

@ray.remote
class EnvActor:
    def __init__(self, env_id):
        self.env_id = env_id
        np.random.seed(env_id)  # ç¡®ä¿ä¸åŒç¯å¢ƒè¡Œä¸ºä¸åŒ

    def step(self, action):
        """æ¨¡æ‹Ÿ C++ äº¤äº’ï¼Œè¿”å› (obs, reward, done)"""
        time.sleep(np.random.uniform(0.01, 0.05))  # æ¨¡æ‹Ÿä¸åŒç¯å¢ƒçš„è®¡ç®—æ—¶é—´
        obs = np.random.rand(3)  # ä¼ªé€ è§‚æµ‹å€¼
        reward = np.random.rand()  # ä¼ªé€ å¥–åŠ±
        done = np.random.rand() < 0.05  # ä¼ªé€ ç»ˆæ­¢æ ‡å¿—
        return obs, reward, done

    def reset(self):
        """å¤ä½ç¯å¢ƒ"""
        return np.random.rand(3)

# åˆå§‹åŒ–
num_envs = 2
workers = [EnvActor.remote(i) for i in range(num_envs)]
agent = Agent()

# å¤ä½æ‰€æœ‰ç¯å¢ƒ
obs_dict = {worker: ray.get(worker.reset.remote()) for worker in workers}

# **åˆå§‹åŒ– step ä»»åŠ¡**
tasks = {worker.step.remote(0): worker for worker in workers}  # å…ˆéšä¾¿ç»™ä¸ªåŠ¨ä½œ

buffer = deque(maxlen=3)

while len(buffer) < 3:
    # **ç­‰å¾…å¤šä¸ªç¯å¢ƒå®Œæˆ step**
    num_ready = min(2, len(tasks))
    ready_tasks, _ = ray.wait(list(tasks.keys()), num_returns=num_ready)

    # **æ‰¹é‡è·å–å¤šä¸ªä»»åŠ¡çš„ (obs, reward, done) ç»“æœ**
    results = ray.get(ready_tasks)

    # **å­˜å‚¨æ–°çš„ç¯å¢ƒçŠ¶æ€**
    new_obs_list = []
    worker_list = []

    for task, (obs, reward, done) in zip(ready_tasks, results):
        worker = tasks.pop(task)  # æ‰¾åˆ°å¯¹åº”çš„ worker
        buffer.append((obs_dict[worker], obs, reward, done))  # å­˜ç»éªŒ (s, s', r, done)

        if done:
            new_obs = ray.get(worker.reset.remote())  # å¤ä½ç¯å¢ƒ
        else:
            new_obs = obs  # å¦åˆ™ä½¿ç”¨ step è¿”å›çš„ obs ä½œä¸ºæ–°çŠ¶æ€

        obs_dict[worker] = new_obs  # æ›´æ–°çŠ¶æ€
        new_obs_list.append(new_obs)
        worker_list.append(worker)

    # **æ‰¹é‡æ¨ç†åŠ¨ä½œ**
    actions = agent.choose_action(new_obs_list)  # ç°åœ¨æ˜¯ batch å¤„ç†

    # **æ´¾å‘ step ä»»åŠ¡**
    for worker, action in zip(worker_list, actions):
        tasks[worker.step.remote(action)] = worker  # ç»§ç»­æ´¾å‘ä»»åŠ¡

    if len(buffer) % 10 == 0 or len(buffer) == 3:
        print(f"å·²æ”¶é›† {len(buffer)}/3 æ ·æœ¬", end="\r")

print("\næ•°æ®æ”¶é›†å®Œæ¯•ï¼å¼€å§‹è®­ç»ƒ PPO...")
agent.update(buffer)  # è®­ç»ƒæ™ºèƒ½ä½“
```





# å‚è€ƒèµ„æ–™

===

* [chaihahaha/dl-template/blob/main/rl_ray_ppo](https://github.com/chaihahaha/dl-template/blob/main/rl_ray_ppo.py)

è¿™æ˜¯ä¸ªåŸºäºrayçš„å¼ºåŒ–å­¦ä¹ ppoç®—æ³•å®ç°

* [æœºå™¨å­¦ä¹ æ¡†æ¶Ray -- 3.2 RayRLlibè®­ç»ƒBipedalWalker](https://blog.csdn.net/wenquantongxin/article/details/130461821)